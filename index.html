<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç¬¬ä¸€ä¸ªJSå°æ¸¸æˆ</title>
    <script src="phaser.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
        background: url('res/big_background.jpg') no-repeat center center fixed;
        background-size: cover;
        position: relative; /* ä¸ºå·¦ä¾§æ å®šä½åšå‡†å¤‡ */
      }

      canvas {
        display: block;
        margin: 0 auto;
        border: 2px solid #333;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }
            #game-rules {
        position: absolute;
        left: 10px;
        top: 10px;
        width: 220px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 10px;
        font-family: "Microsoft YaHei", sans-serif;
        font-size: 16px;
        line-height: 1.6;
        z-index: 10;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* å·¦ä¾§æ¸¸æˆè§„åˆ™é¢æ¿ */
      #game-rules h3 {
        margin-top: 0;
        color: #ffcc00;
        text-align: center;
      }

      #game-rules ul {
        padding-left: 20px;
        margin-bottom: 0;
      }

      #game-rules li {
        margin-bottom: 8px;
      }
    </style>
</head>
<body>
        <!-- æ–°å¢ï¼šæ¸¸æˆè§„åˆ™è¯´æ˜ -->
    <div id="game-rules">
        <h3>ğŸ® æ¸¸æˆè§„åˆ™</h3>
        <ul>
            <li><strong>â†‘</strong>ï¼šè·³è·ƒ</li>
            <li><strong>â† â†’</strong>ï¼šå·¦å³ç§»åŠ¨</li>
            <li><strong>ç©ºæ ¼é”®</strong>ï¼š
                <ul style="margin-top: 5px; margin-bottom: 0;">
                    <li>â€¢ å¼€å§‹æ¸¸æˆ</li>
                    <li>â€¢ è·å¾—é‡‘å¸åï¼šé‡Šæ”¾â€œåŠæœˆæ–©â€</li>
                </ul>
            </li>
        </ul>
    </div>
    <script>
        var config = {
  type: Phaser.AUTO,
  width: 1208,
  height: 668,
  physics: {
    default: "arcade",
    arcade: {
      gravity: {
        y: 800,
      },
      debug: false,
    },
  },
  scene: {
    preload: preload,
    create: create,
    update: update,
  },
};
var game = new Phaser.Game(config);

// åœ°å›¾å®½åº¦ - å¢åŠ 50%
var MAP_WIDTH = 3600;
var gameOver = false;
var gameStarted = false;
var cursors;
var characterSelected = false;
var selectedCharacter = 'xiyangyang';

// è¿›åº¦æ¡ç›¸å…³å˜é‡
var progressBar;
var progressText;
var progressBox;
var playerStartX = 100;
var progressPercentage = 0;
var coins;
var playerIsRed = false;
var lasers;
var laserKey;
var diren; // <-- æ·»åŠ è¿™è¡Œ

function preload() {
    this.load.image("background", "res/background.jpg");
    this.load.image("brick", "res/brick.png");
    this.load.image("enemy", "res/enemy.png");
    this.load.image("ground", "res/ground.png");
    this.load.image("bullet", "res/bullet.png"); 
    this.load.image("xijundawang_stand", "res/xijundawang_stand.png");
    this.load.image("xijundawang_walk", "res/xijundawang_walk.png");
    this.load.image("start", "res/start.jpg");
    this.load.image("gameover", "res/gameover.jpg");
    this.load.image("success", "res/success.jpg");
    
    // åŠ è½½è§’è‰²å›¾ç‰‡
    this.load.image("xiyangyang_stand", "res/xiyangyang_stand.png");
    this.load.image("xiyangyang_walk", "res/xiyangyang_walk.png");
    this.load.image("meiyangyang_stand", "res/meiyangyang_stand.png");
    this.load.image("meiyangyang_walk", "res/meiyangyang_walk.png");
    this.load.image("huitailang_stand", "res/huitailang_stand.png");
    this.load.image("huitailang_walk", "res/huitailang_walk.png");
    
    // åŠ è½½ç»ˆç‚¹å›¾ç‰‡
    this.load.image("zhongdian", "res/zhongdian.png");
    this.load.image("coin", "res/coin.png");
    this.load.image("jiguang", "res/jiguang.png");
    this.load.image("diren", "res/diren.png");
    
    // åŠ è½½éŸ³æ•ˆ
    this.load.audio("jumpSound", "res/jump.mp3");
    this.load.audio("gameoverSound", "res/gameover.mp3");
    this.load.audio("successSound", "res/success.mp3");
    this.load.audio("backgroundMusic", "res/background.mp3");
     
}

function create() {
    // åˆå§‹åŒ–é”®ç›˜è¾“å…¥
    cursors = this.input.keyboard.createCursorKeys();
    
    // æ˜¾ç¤ºå¼€å§‹ç•Œé¢
    startScreen = this.add.image(config.width / 2, config.height / 2, "start").setScale(1);
    
    // ç›‘å¬ç©ºæ ¼é”®
    spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    
    // åˆå§‹åŒ–éŸ³æ•ˆ
    jumpSound = this.sound.add("jumpSound");
    gameoverSound = this.sound.add("gameoverSound");
    successSound = this.sound.add("successSound");
    backgroundMusic = this.sound.add("backgroundMusic", { loop: true });
    backgroundMusic.play();
    laserKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
lasers = this.physics.add.group();
}

function showCharacterSelection() {
    // ç§»é™¤å¼€å§‹ç•Œé¢
    startScreen.destroy();
    
    // æ·»åŠ é€‰æ‹©è§’è‰²æ–‡å­—
    var selectText = this.add.text(config.width / 2, 100, 'é€‰æ‹©ä½ çš„è§’è‰²', {
        fontSize: '48px',
        fill: '#ffffff',
        fontStyle: 'bold',
        stroke: '#000000',
        strokeThickness: 6
    }).setOrigin(0.5);
    
    // åˆ›å»ºè§’è‰²é€‰æ‹©åŒºåŸŸ
    var characterSpacing = 200;
    var startX = config.width / 2 - characterSpacing;
    
    // å–œç¾Šç¾Š
    var xiyangyang = this.add.image(startX, config.height / 2, "xiyangyang_stand")
        .setScale(0.2)
        .setInteractive({ useHandCursor: true });
    
    // ç¾ç¾Šç¾Š
    var meiyangyang = this.add.image(startX + characterSpacing, config.height / 2, "meiyangyang_stand")
        .setScale(0.2)
        .setInteractive({ useHandCursor: true });
    
    // ç°å¤ªç‹¼
    var huitailang = this.add.image(startX + characterSpacing * 2, config.height / 2, "huitailang_stand")
        .setScale(0.2)
        .setInteractive({ useHandCursor: true });
    
    // æ·»åŠ è§’è‰²åå­—
    this.add.text(startX, config.height / 2 + 80, 'å–œç¾Šç¾Š', {
        fontSize: '24px',
        fill: '#ffffff',
        fontStyle: 'bold'
    }).setOrigin(0.5);
    
    this.add.text(startX + characterSpacing, config.height / 2 + 80, 'ç¾ç¾Šç¾Š', {
        fontSize: '24px',
        fill: '#ffffff',
        fontStyle: 'bold'
    }).setOrigin(0.5);
    
    this.add.text(startX + characterSpacing * 2, config.height / 2 + 80, 'ç°å¤ªç‹¼', {
        fontSize: '24px',
        fill: '#ffffff',
        fontStyle: 'bold'
    }).setOrigin(0.5);
    
    // æ·»åŠ é€‰æ‹©æ¡†ï¼ˆåˆå§‹éšè—ï¼‰
    var selectionBox = this.add.graphics();
    selectionBox.lineStyle(4, 0xffff00, 1);
    selectionBox.strokeRect(-75, -75, 150, 150);
    selectionBox.setVisible(false);
    
    // ä¿å­˜å½“å‰åœºæ™¯çš„å¼•ç”¨
    var currentScene = this;
    var confirmButton = null;
    
    // è§’è‰²æ‚¬åœæ•ˆæœ
    [xiyangyang, meiyangyang, huitailang].forEach(character => {
        character.on('pointerover', function() {
            this.setScale(0.22);
            this.setTint(0xcccccc);
        });
        
        character.on('pointerout', function() {
            this.setScale(0.2);
            this.clearTint();
        });
        
        character.on('pointerdown', function() {
            // éšè—é€‰æ‹©æ¡†
            selectionBox.setVisible(false);
            
            // åœ¨é€‰æ‹©è§’è‰²ä¸Šæ˜¾ç¤ºé»„è‰²é€‰æ‹©æ¡†
            selectionBox.setPosition(this.x, this.y);
            selectionBox.setVisible(true);
            
            // è®¾ç½®é€‰ä¸­çš„è§’è‰²
            if (this.texture.key === 'xiyangyang_stand') {
                selectedCharacter = 'xiyangyang';
            } else if (this.texture.key === 'meiyangyang_stand') {
                selectedCharacter = 'meiyangyang';
            } else if (this.texture.key === 'huitailang_stand') {
                selectedCharacter = 'huitailang';
            }
            
            // å¦‚æœå·²ç»æœ‰ç¡®è®¤æŒ‰é’®ï¼Œå…ˆé”€æ¯
            if (confirmButton) {
                confirmButton.destroy();
            }
            
            // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            confirmButton = currentScene.add.text(config.width / 2, config.height - 100, 'ç¡®è®¤é€‰æ‹©', {
                fontSize: '36px',
                fill: '#ffffff',
                backgroundColor: '#4CAF50',
                padding: { x: 20, y: 10 }
            }).setOrigin(0.5).setInteractive({ useHandCursor: true });
            
            confirmButton.on('pointerover', function() {
                this.setFill('#ffff00');
                this.setBackgroundColor('#45a049');
            });
            
            confirmButton.on('pointerout', function() {
                this.setFill('#ffffff');
                this.setBackgroundColor('#4CAF50');
            });
            
            confirmButton.on('pointerdown', function() {
                characterSelected = true;
                selectText.destroy();
                xiyangyang.destroy();
                meiyangyang.destroy();
                huitailang.destroy();
                selectionBox.destroy();
                this.destroy();
                
                // ä½¿ç”¨ä¿å­˜çš„åœºæ™¯å¼•ç”¨è°ƒç”¨startGame
                startGame.call(currentScene);
            });
        });
    });
}

function startGame() {
    // è®¾ç½®ä¸–ç•Œè¾¹ç•Œ
    this.physics.world.setBounds(0, 0, MAP_WIDTH, 668);
    
    // èƒŒæ™¯
    background = this.add.tileSprite(0, 0, MAP_WIDTH, 668, "background").setOrigin(0, 0).setScale(4);
    
    // æ ¹æ®é€‰æ‹©çš„è§’è‰²åˆ›å»ºç©å®¶
    var standTexture = selectedCharacter + '_stand';
    var walkTexture = selectedCharacter + '_walk';
    
    player = this.physics.add.sprite(100, 400, standTexture).setScale(0.1);
    if (this.sys.game.config.renderType === Phaser.WEBGL) {
    player.setPipeline('GlowFX');
    player.glowEnabled = false;
    player.glowColor = 0xffff00; // é‡‘è‰²
    player.glowOuterStrength = 6; // å‘å…‰å¼ºåº¦
    player.glowInnerStrength = 0;
}
    player.setCollideWorldBounds(true);
    playerState = "standing";

    
    // å­˜å‚¨è§’è‰²çº¹ç†
    player.standTexture = standTexture;
    player.walkTexture = walkTexture;
    player.jumpTexture = standTexture;
    
    // åˆ›å»ºè¿›åº¦æ¡
    createProgressBar.call(this);
    
    // å¹³å°ç»„
    platforms = this.physics.add.staticGroup();
    
    // åœ°é¢ - æ­»äº¡åŒºåŸŸ
    deathZone = this.physics.add.staticGroup();
    for (let x = 0; x < MAP_WIDTH; x += 120) {
        deathZone.create(x, 650, "ground").setScale(0.5, 0.5).setTint(0xff0000).refreshBody();
    }
    
    // åˆ›å»ºå¹³å° - å»¶é•¿äº†åœ°å›¾ï¼Œå¢åŠ äº†æ›´å¤šå¹³å°
    platforms.create(110, 600, "brick").setScale(0.5).refreshBody();
    platforms.create(230, 600, "brick").setScale(0.5).refreshBody();
    platforms.create(500, 500, "brick").setScale(0.5).refreshBody();
    platforms.create(620, 500, "brick").setScale(0.5).refreshBody();
    platforms.create(740, 500, "brick").setScale(0.5).refreshBody();
    platforms.create(860, 500, "brick").setScale(0.5).refreshBody();
    platforms.create(1000, 550, "brick").setScale(0.5).refreshBody();
    platforms.create(1230, 450, "brick").setScale(0.5).refreshBody();
    platforms.create(1400,550, "brick").setScale(0.5).refreshBody();
    platforms.create(1600,550, "brick").setScale(0.5).refreshBody();
    platforms.create(1800, 450, "brick").setScale(0.5).refreshBody();
    platforms.create(2000, 350, "brick").setScale(0.5).refreshBody();
        coins = this.physics.add.staticGroup();
        coins.create(2000, 320, "coin").setScale(0.08).refreshBody();
    platforms.create(2200, 450, "brick").setScale(0.5).refreshBody();
    platforms.create(2400, 550, "brick").setScale(0.5).refreshBody();
    platforms.create(2520, 550, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    platforms.create(2640, 550, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    platforms.create(2760, 550, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    platforms.create(2880, 550, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    // æ–°æ•Œäºº - ä¸Šä¸‹ç§»åŠ¨
diren = this.physics.add.sprite(2880, 400, "diren").setScale(0.1);
diren.setCollideWorldBounds(true);
diren.body.setAllowGravity(false);
diren.setVelocityY(120); // ä¸Šä¸‹é€Ÿåº¦
diren.minY = 300;
diren.maxY = 500;
    platforms.create(3000, 550, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    platforms.create(3200, 500, "brick").setScale(0.5).refreshBody(); // æ–°å¢å¹³å°
    
    // ç»ˆç‚¹å¹³å°
    var endPlatform = platforms.create(MAP_WIDTH - 100, 500, "brick").setScale(0.5).setTint(0x00ff00).refreshBody();
    
    // åœ¨ç»ˆç‚¹å¹³å°ä¸Šæ–¹æ·»åŠ ç»ˆç‚¹æ ‡å¿—
    var endFlag = this.add.image(MAP_WIDTH - 100, 500, "zhongdian");
    endFlag.setScale(0.2); // è°ƒæ•´å¤§å°ä»¥é€‚åº”åœºæ™¯
    endFlag.setOrigin(0.5, 1); // è®¾ç½®åŸç‚¹åœ¨åº•éƒ¨ä¸­å¿ƒ
    
    // æ•Œäºº
    enemy = this.physics.add.sprite(1600, 200, "enemy").setScale(0.1);
    enemy.setCollideWorldBounds(true);
    enemy.body.setAllowGravity(false);
    enemy.setVelocityY(100);
    
    // ç‚®å¼¹ç»„
    bullets = this.physics.add.group();
    
    // å‘å°„ç‚®å¼¹çš„è®¡æ—¶å™¨
    bulletTimer = this.time.addEvent({
        delay: 1500,
        callback: shootBullet,
        callbackScope: this,
        loop: true
    });
    
    // ç»†èŒå¤§ç‹
    xijundawang = this.physics.add.sprite(620, 450, "xijundawang_walk").setScale(0.1);
    xijundawang.setCollideWorldBounds(false);
    xijundawang.body.setAllowGravity(false);
    xijundawang.setVelocityX(100);
    xijundawang.direction = 1;
    xijundawang.alive = true;
    
    // è®¾ç½®ç»†èŒå¤§ç‹çš„ç§»åŠ¨èŒƒå›´
    xijundawang.leftBound = 500;
    xijundawang.rightBound = 860;
    
    // æç¤ºæ–‡å­—
    var tip1 = this.add.text(500, 400, 'å¯ä»¥ä»ä¸Šæ–¹è¸©æ­»ç»†èŒå¤§ç‹å“¦ï¼', { 
        fontSize: '20px', 
        fill: '#ffff00',
        stroke: '#000',
        strokeThickness: 3,
        padding: { x: 10, y: 5 }
    }).setOrigin(0.5);
    
    var tip2 = this.add.text(1000, 300, 'å°å¿ƒä¸è¦è¢«ç‚¸å¼¹ç¢°åˆ°ï¼', { 
        fontSize: '20px', 
        fill: '#ff0000',
        stroke: '#000',
        strokeThickness: 3,
        padding: { x: 10, y: 5 }
    }).setOrigin(0.5);
    
    // åœ¨æ–°å¢åŒºåŸŸæ·»åŠ æ›´å¤šæç¤º
    var tip3 = this.add.text(2000, 250, 'åƒäº†å¯ä»¥è·å¾—â€œåŠæœˆæ–©â€æŠ€èƒ½å“¦ï¼ç‚¹ç©ºæ ¼', { 
        fontSize: '20px', 
        fill: '#00ff00',
        stroke: '#000',
        strokeThickness: 3,
        padding: { x: 10, y: 5 }
    }).setOrigin(0.5);
    
    var tip4 = this.add.text(2500, 350, 'è¯•è¯•è·³èµ·æ¥ç‚¹ç©ºæ ¼è¿å‘ï¼', { 
        fontSize: '20px', 
        fill: '#ff00ff',
        stroke: '#000',
        strokeThickness: 3,
        padding: { x: 10, y: 5 }
    }).setOrigin(0.5);

            this.physics.add.overlap(player, coins, collectCoin, null, this);
    // ç¢°æ’æ£€æµ‹
    this.physics.add.collider(player, platforms);
    this.physics.add.collider(player, deathZone, hitDeathZone, null, this);
    this.physics.add.collider(player, bullets, hitBullet, null, this);
    this.physics.add.collider(bullets, platforms, bulletHitPlatform, null, this);
    this.physics.add.collider(player, xijundawang, hitXijundawang, null, this);
    this.physics.add.collider(lasers, enemy, hitEnemyWithLaser, null, this);
this.physics.add.collider(lasers, xijundawang, hitEnemyWithLaser, null, this);
this.physics.add.collider(lasers, platforms, destroyLaser, null, this);
// ç©å®¶ç¢°åˆ°æ–°æ•Œäºº â†’ æ­»äº¡
this.physics.add.collider(player, diren, hitDiren, null, this);

// æ¿€å…‰å‡»ä¸­æ–°æ•Œäºº â†’ æ¶ˆå¤±
this.physics.add.collider(lasers, diren, hitEnemyWithLaser, null, this);
    // è®¾ç½®ç›¸æœº
    this.cameras.main.setBounds(0, 0, MAP_WIDTH, 668);
    this.cameras.main.startFollow(player);
    this.cameras.main.setFollowOffset(-config.width / 4, 0);
    
    gameStarted = true;
}

// æ”¶é›†é‡‘å¸å‡½æ•°
function collectCoin(player, coin) {
    coin.disableBody(true, true);
    player.setTint(0xff0000);
    playerIsRed = true;
}
// åˆ›å»ºè¿›åº¦æ¡å‡½æ•°
function createProgressBar() {
    // è¿›åº¦æ¡èƒŒæ™¯æ¡†
    progressBox = this.add.graphics();
    progressBox.fillStyle(0x222222, 0.8);
    progressBox.fillRect(20, 20, 200, 30);
    progressBox.setScrollFactor(0);
    
    // è¿›åº¦æ¡
    progressBar = this.add.graphics();
    progressBar.setScrollFactor(0);
    
    // è¿›åº¦æ–‡æœ¬
    progressText = this.add.text(110, 35, '0%', { 
        fontSize: '18px', 
        fill: '#ffffff',
        fontStyle: 'bold'
    }).setOrigin(0.5);
    progressText.setScrollFactor(0);
    
    // æ›´æ–°è¿›åº¦æ¡åˆå§‹çŠ¶æ€
    updateProgressBar.call(this);
}

// æ›´æ–°è¿›åº¦æ¡å‡½æ•°
function updateProgressBar() {
    var totalDistance = MAP_WIDTH - 250;
    var currentDistance = Math.max(0, player.x - playerStartX);
    progressPercentage = Math.min(100, Math.round((currentDistance / totalDistance) * 100));
    
    // æ¸…é™¤ä¹‹å‰çš„è¿›åº¦æ¡
    progressBar.clear();
    
    // ç»˜åˆ¶è¿›åº¦æ¡
    progressBar.fillStyle(0x444444, 1);
    progressBar.fillRect(22, 22, 196, 26);
    
    var fillColor;
    if (progressPercentage < 30) {
        fillColor = 0xff0000;
    } else if (progressPercentage < 70) {
        fillColor = 0xffff00;
    } else {
        fillColor = 0x00ff00;
    }
    
    var fillWidth = (196 * progressPercentage) / 100;
    progressBar.fillStyle(fillColor, 1);
    progressBar.fillRect(22, 22, fillWidth, 26);
    
    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    progressText.setText(progressPercentage + '%');
}

function update() {
    if (!gameStarted) {
        if (Phaser.Input.Keyboard.JustDown(spaceKey)) {
            showCharacterSelection.call(this);
        }
        return;
    }
    
    if (gameOver) return;
    if (playerIsRed && Phaser.Input.Keyboard.JustDown(laserKey)) {
    shootLaser.call(this);
}
    
    // è®¾ç½®äººç‰©åœ¨xæ–¹å‘çš„é€Ÿåº¦ä¸º0
    player.setVelocityX(0);
    
    // æ»šåŠ¨èƒŒæ™¯
    background.tilePositionX = this.cameras.main.scrollX * 0.5;
    
    // è·³è·ƒ
    if (cursors.up.isDown && player.body.onFloor()) {
        player.setVelocityY(-450);
        playerState = "jumping";
        player.setTexture(player.standTexture);
        jumpSound.play();
    }
    
    // ç«™ç«‹çŠ¶æ€
    if (playerState !== "jumping" && player.body.velocity.x === 0) {
        playerState = "standing";
        player.setTexture(player.standTexture);
    }
    
    // å·¦å³ç§»åŠ¨
    if (cursors.left.isDown) {
        player.setVelocityX(-250);
        player.setFlipX(true);
        if (playerState !== "jumping") {
            playerState = "walking";
            player.setTexture(player.walkTexture);
        }
    } else if (cursors.right.isDown) {
        player.setVelocityX(250);
        player.setFlipX(false);
        if (playerState !== "jumping") {
            playerState = "walking";
            player.setTexture(player.walkTexture);
        }
    }
    
    // æ£€æµ‹æ˜¯å¦è½åœ°
    if (playerState == "jumping" && player.body.onFloor()) {
        playerState = "standing";
        player.setTexture(player.standTexture);
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    updateProgressBar.call(this);
    
    // æ•Œäººä¸Šä¸‹ç§»åŠ¨
    if (enemy.y >= 400) {
        enemy.setVelocityY(-100);
    } else if (enemy.y <= 100) {
        enemy.setVelocityY(100);
    }
    // æ–°æ•Œäººä¸Šä¸‹ç§»åŠ¨
if (diren && diren.active) {
    if (diren.y >= diren.maxY) {
        diren.setVelocityY(-120);
    } else if (diren.y <= diren.minY) {
        diren.setVelocityY(120);
    }
}

    // ç»†èŒå¤§ç‹å·¦å³ç§»åŠ¨
    if (xijundawang.alive) {
        if (xijundawang.x >= xijundawang.rightBound) {
            xijundawang.direction = -1;
            xijundawang.setVelocityX(-100);
            xijundawang.setFlipX(true);
        } else if (xijundawang.x <= xijundawang.leftBound) {
            xijundawang.direction = 1;
            xijundawang.setVelocityX(100);
            xijundawang.setFlipX(false);
        }
    }
    
    // æ£€æŸ¥é€šå…³
    if (player.x >= MAP_WIDTH - 150 && player.body.onFloor()) {
        gameOver = true;
        backgroundMusic.stop();
        successSound.play();
        
        // æ˜¾ç¤ºæˆåŠŸç•Œé¢
        this.add.image(config.width / 2, config.height / 2, "success")
            .setDisplaySize(config.width, config.height)
            .setScrollFactor(0);
        
        // åœæ­¢æ•Œäººå’Œç‚®å¼¹
        enemy.setVelocity(0, 0);
        bulletTimer.remove();
    }
}

function shootBullet() {
    if (gameOver) return;
    
    var bullet = bullets.create(enemy.x, enemy.y, "bullet");
    if (!bullet) return;
    
    bullet.setScale(0.05);
    bullet.setTint(0xff0000);
    bullet.body.setAllowGravity(false);
    bullet.setVelocityX(-300);
    
    bullet.setCollideWorldBounds(false);
    bullet.checkWorldBounds = true;
    bullet.outOfBoundsKill = true;
}

function hitBullet(player, bullet) {
    if (gameOver) return;
    
    bullet.destroy();
    hitDeathZone.call(this);
}

function bulletHitPlatform(bullet, platform) {
    bullet.destroy();
}

function hitDeathZone() {
    if (gameOver) return;
    
    gameOver = true;
    backgroundMusic.stop();
    gameoverSound.play();
    
    this.physics.pause();
    player.setTint(0xff0000);
    
    // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
    this.add.image(config.width / 2, config.height / 2, "gameover")
        .setDisplaySize(config.width, config.height)
        .setScrollFactor(0);
}

function hitXijundawang(player, xijundawang) {
    if (gameOver) return;
    
    // æ£€æŸ¥ç©å®¶æ˜¯å¦ä»ä¸Šæ–¹è¸©åˆ°ç»†èŒå¤§ç‹
    if (player.body.velocity.y > 0 && player.body.bottom <= xijundawang.body.top + 10) {
        // è¸©æ­»ç»†èŒå¤§ç‹
        xijundawang.alive = false;
        xijundawang.setVelocity(0, 0);
        xijundawang.setTint(0x888888);
        xijundawang.body.enable = false;
        
        // ç»™ç©å®¶ä¸€ä¸ªåå¼¹åŠ›
        player.setVelocityY(-300);
        
        // ä¸€ç§’åæ¶ˆå¤±
        this.time.delayedCall(1000, function() {
            xijundawang.destroy();
        }, [], this);
    } else {
        // ç©å®¶ç¢°åˆ°ç»†èŒå¤§ç‹ä¾§é¢ï¼Œæ¸¸æˆç»“æŸ
        gameOver = true;
        backgroundMusic.stop();
        gameoverSound.play();
        
        this.physics.pause();
        player.setTint(0xff0000);
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
        this.add.image(config.width / 2, config.height / 2, "gameover")
            .setDisplaySize(config.width, config.height)
            .setScrollFactor(0);
    }
}
function shootLaser() {
    if (!player || !player.active || !playerIsRed) return;

    // åˆ›å»ºç‚¸å¼¹ï¼ˆä½¿ç”¨ jiguang.pngï¼‰
    var bomb = lasers.create(player.x + 30, player.y, "jiguang");
    
    if (!bomb) return;

    bomb.setScale(0.1);
    bomb.body.setAllowGravity(false);
    bomb.setVelocityX(500); // å›ºå®šå‘å³ï¼Œé€Ÿåº¦å¯è°ƒ

    // ç¦»å¼€ä¸–ç•Œè¾¹ç•Œæ—¶è‡ªåŠ¨é”€æ¯
    bomb.checkWorldBounds = true;
    bomb.outOfBoundsKill = true;
}
function hitEnemyWithLaser(laser, enemy) {
    laser.destroy();
    if (enemy === xijundawang && xijundawang.alive) {
        xijundawang.alive = false;
        xijundawang.setVelocity(0, 0);
        xijundawang.setTint(0x888888);
        xijundawang.body.enable = false;
        this.time.delayedCall(1000, function() {
            xijundawang.destroy();
        }, [], this);
    }
}

function destroyLaser(laser, platform) {
    laser.destroy();
}
function hitDiren(player, diren) {
    if (gameOver) return;
    
    gameOver = true;
    backgroundMusic.stop();
    gameoverSound.play();
    
    this.physics.pause();
    player.setTint(0xff0000);
    
    // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
    this.add.image(config.width / 2, config.height / 2, "gameover")
        .setDisplaySize(config.width, config.height)
        .setScrollFactor(0);
}
    </script>
</body>
</html>